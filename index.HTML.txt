<!DOCTYPE html>
<html>
<head>
<title>Night Drive Playlist Creator</title>
</head>
<body>
<h1>Night Drive – 12hr Psychedelic Playlist Creator</h1>

<button id="loginBtn">Login with Spotify</button><br><br>

<label>Track List (Track Name - Artist, one per line):</label><br>
<textarea id="tracklist" rows="20" style="width:100%">
It Is Not Meant to Be - Tame Impala
Desire Be, Desire Go - Tame Impala
Alter Ego - Tame Impala
Lucidity - Tame Impala
Why Won’t You Make Up Your Mind? - Tame Impala
Solitude Is Bliss - Tame Impala
Jeremy’s Storm - Tame Impala
Expectation - Tame Impala
The Bold Arrow of Time - Tame Impala
Runway, Houses, City, Clouds - Tame Impala
I Don’t Really Mind - Tame Impala
Be Above It - Tame Impala
Endors Toi - Tame Impala
Apocalypse Dreams - Tame Impala
Mind Mischief - Tame Impala
Music to Walk Home By - Tame Impala
Why Won’t They Talk to Me? - Tame Impala
Feels Like We Only Go Backwards - Tame Impala
Keep on Lying - Tame Impala
Elephant - Tame Impala
She Just Won’t Believe Me - Tame Impala
Nothing That Has Happened So Far… - Tame Impala
Sun’s Coming Up - Tame Impala
Let It Happen - Tame Impala
Nangs - Tame Impala
The Moment - Tame Impala
Yes I’m Changing - Tame Impala
Eventually - Tame Impala
Gossip - Tame Impala
The Less I Know the Better - Tame Impala
Past Life - Tame Impala
Disciples - Tame Impala
’Cause I’m a Man - Tame Impala
Reality in Motion - Tame Impala
Love/Paranoia - Tame Impala
New Person, Same Old Mistakes - Tame Impala
One More Year - Tame Impala
Instant Destiny - Tame Impala
Borderline - Tame Impala
Posthumous Forgiveness - Tame Impala
Breathe Deeper - Tame Impala
Tomorrow’s Dust - Tame Impala
On Track - Tame Impala
Lost in Yesterday - Tame Impala
Is It True - Tame Impala
It Might Be Time - Tame Impala
Glimmer - Tame Impala
One More Minute - Tame Impala
</textarea><br><br>

<label>Playlist Name:</label><br>
<input type="text" id="playlistName" value="Night Drive – Psychedelic Marathon" style="width:100%"><br><br>

<button id="createBtn">Create Playlist</button>

<p id="status"></p>

<script>
const clientId = 'cea528a5f089480abe5cef0942dca6c1';
const redirectUri = window.location.href.split('#')[0];
const scopes = 'playlist-modify-public playlist-modify-private';

// Capture token from Spotify redirect
window.onload = () => {
  if(window.location.hash.includes('access_token')) {
    const token = new URLSearchParams(window.location.hash.slice(1)).get('access_token');
    if(token) {
      localStorage.setItem('access_token', token);
      alert("Spotify login successful! Access token saved.");
      history.replaceState(null,null,redirectUri);
    }
  }
};

document.getElementById('loginBtn').onclick = () => {
  const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
  window.location.href = authUrl;
};

document.getElementById('createBtn').onclick = async () => {
  const status = document.getElementById('status');
  status.innerText = "Creating playlist...";

  const accessToken = localStorage.getItem('access_token');
  if(!accessToken){ alert("Login first!"); return; }

  const trackText = document.getElementById('tracklist').value.trim();
  if(!trackText){ alert("Paste or use preloaded tracklist."); return; }
  const tracks = trackText.split('\n');
  const playlistName = document.getElementById('playlistName').value.trim();

  const userResp = await fetch('https://api.spotify.com/v1/me', {headers:{Authorization:'Bearer '+accessToken}});
  const userData = await userResp.json();
  const userId = userData.id;

  const createResp = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
    method:'POST',
    headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
    body:JSON.stringify({name:playlistName,description:"Tame Impala + night driving psych vibes",public:false})
  });
  const playlistData = await createResp.json();
  const playlistId = playlistData.id;

  let uris=[];
  for(const t of tracks){
    const q = encodeURIComponent(t);
    const searchResp = await fetch(`https://api.spotify.com/v1/search?q=${q}&type=track&limit=1`,{headers:{Authorization:'Bearer '+accessToken}});
    const searchData = await searchResp.json();
    if(searchData.tracks.items.length>0)uris.push(searchData.tracks.items[0].uri);
  }

  for(let i=0;i<uris.length;i+=100){
    const batch=uris.slice(i,i+100);
    await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`,{
      method:'POST',
      headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},
      body:JSON.stringify({uris:batch})
    });
  }

  status.innerHTML=`Playlist created! <a href="https://open.spotify.com/playlist/${playlistId}" target="_blank">Open in Spotify</a>`;
};
</script>
</body>
</html>